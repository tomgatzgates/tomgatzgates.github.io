<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>CLAG — Clouds Low Aircraft Grounded</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Oswald:wght@300;400;600;700&family=Special+Elite&display=swap" rel="stylesheet">
<style>
:root {
  --ink: #1a1a14;
  --panel: #1e1e14;
  --amber: #e8a820;
  --amber-dim: #a07010;
  --amber-glow: rgba(232,168,32,0.12);
  --green: #4a7c3f;
  --green-bright: #6db560;
  --red: #c0392b;
  --cream: #d4c89a;
  --cream-dim: #8a7e5a;
  --border: rgba(232,168,32,0.3);
  --border-dim: rgba(212,200,154,0.15);
  --grid: rgba(232,168,32,0.055);
}

- { box-sizing: border-box; margin: 0; padding: 0; }

body {
background: var(–ink);
color: var(–cream);
font-family: ‘Share Tech Mono’, monospace;
min-height: 100vh;
overflow-x: hidden;
background-image:
repeating-linear-gradient(0deg, var(–grid) 0, var(–grid) 1px, transparent 1px, transparent 40px),
repeating-linear-gradient(90deg, var(–grid) 0, var(–grid) 1px, transparent 1px, transparent 40px);
}
body::before {
content: ‘’;
position: fixed;
inset: 0;
background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.07) 2px, rgba(0,0,0,0.07) 4px);
pointer-events: none;
z-index: 999;
}

.container {
max-width: 520px;
margin: 0 auto;
padding: 0 16px 80px;
}

/* ── HEADER ── */
header {
border-bottom: 2px solid var(–amber);
padding: 18px 0 14px;
margin-bottom: 22px;
}
.header-inner { display: flex; align-items: center; gap: 13px; }
.roundel { width: 42px; height: 42px; flex-shrink: 0; }
.clag-title {
font-family: ‘Oswald’, sans-serif;
font-weight: 700;
font-size: 2.1rem;
letter-spacing: 0.25em;
color: var(–amber);
line-height: 1;
text-shadow: 0 0 28px rgba(232,168,32,0.35);
}
.clag-sub {
font-family: ‘Special Elite’, cursive;
font-size: 0.6rem;
color: var(–cream-dim);
letter-spacing: 0.12em;
margin-top: 3px;
}

/* ── SCREENS ── */
.screen { display: none; }
.screen.active { display: block; }

/* ── RESUME BANNER ── */
.resume-banner {
background: rgba(232,168,32,0.08);
border: 1px solid var(–border);
padding: 13px 15px;
margin-bottom: 16px;
display: flex;
align-items: center;
justify-content: space-between;
gap: 12px;
}
.resume-text { font-size: 0.75rem; color: var(–cream-dim); letter-spacing: 0.04em; line-height: 1.5; }
.resume-text strong { font-family: ‘Oswald’, sans-serif; color: var(–amber); font-weight: 400; font-size: 0.85rem; }
.resume-btns { display: flex; gap: 8px; flex-shrink: 0; }

/* ── PANEL ── */
.panel {
background: var(–panel);
border: 1px solid var(–border);
padding: 18px;
margin-bottom: 14px;
position: relative;
}
.panel::before {
content: ‘’;
position: absolute;
top: 0; left: 0; right: 0;
height: 2px;
background: linear-gradient(90deg, var(–amber), transparent);
}

/* ── SECTION LABEL ── */
.slabel {
font-family: ‘Oswald’, sans-serif;
font-size: 0.58rem;
letter-spacing: 0.28em;
color: var(–amber-dim);
text-transform: uppercase;
margin-bottom: 10px;
display: flex;
align-items: center;
gap: 10px;
}
.slabel::after { content: ‘’; flex: 1; height: 1px; background: var(–border-dim); }

/* ── PLAYER INPUTS ── */
.pinput-row {
display: flex;
align-items: center;
gap: 8px;
background: rgba(0,0,0,0.3);
border: 1px solid var(–border-dim);
padding: 10px 13px;
margin-bottom: 7px;
transition: border-color 0.15s;
}
.pinput-row:focus-within { border-color: var(–amber); }
.pnum { font-family: ‘Oswald’, sans-serif; font-size: 0.62rem; color: var(–amber-dim); letter-spacing: 0.1em; min-width: 20px; }
.pinput-row input {
background: transparent; border: none;
color: var(–cream);
font-family: ‘Share Tech Mono’, monospace;
font-size: 16px; /* prevents iOS zoom */
width: 100%; outline: none;
letter-spacing: 0.04em;
}
.pinput-row input::placeholder { color: var(–cream-dim); opacity: 0.45; }

/* ── RADIO CARDS ── */
.radio-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.rcard { position: relative; cursor: pointer; }
.rcard input { position: absolute; opacity: 0; width: 0; }
.rlabel {
display: block;
border: 1px solid var(–border-dim);
padding: 10px 12px;
cursor: pointer;
background: rgba(0,0,0,0.2);
transition: all 0.12s;
}
.rcard input:checked + .rlabel { border-color: var(–amber); background: var(–amber-glow); }
.rlabel-title { font-family: ‘Oswald’, sans-serif; font-size: 0.78rem; letter-spacing: 0.1em; color: var(–cream); display: block; margin-bottom: 2px; }
.rlabel-sub { font-size: 0.6rem; color: var(–cream-dim); }

/* ── BUTTONS ── */
.btn {
font-family: ‘Oswald’, sans-serif;
font-size: 0.82rem;
letter-spacing: 0.18em;
text-transform: uppercase;
border: none;
cursor: pointer;
padding: 12px 18px;
transition: background 0.12s, opacity 0.12s;
display: inline-flex;
align-items: center;
justify-content: center;
gap: 7px;
-webkit-tap-highlight-color: transparent;
touch-action: manipulation;
user-select: none;
}
.btn-primary { background: var(–amber); color: var(–ink); width: 100%; font-weight: 600; }
.btn-primary:active { background: #f0b830; }
.btn-primary:disabled { opacity: 0.35; cursor: not-allowed; }
.btn-secondary {
background: transparent;
color: var(–cream-dim);
border: 1px solid var(–border-dim);
font-size: 0.68rem;
padding: 9px 14px;
}
.btn-secondary:active { border-color: var(–amber-dim); color: var(–cream); }
.btn-ghost {
background: transparent;
color: var(–cream-dim);
font-size: 0.68rem;
letter-spacing: 0.14em;
padding: 10px 0;
width: 100%;
}
.btn-ghost:active { color: var(–cream); }
.btn-danger {
background: transparent;
color: rgba(192,57,43,0.7);
border: 1px solid rgba(192,57,43,0.25);
font-size: 0.62rem;
padding: 8px 13px;
}
.btn-danger:active { background: rgba(192,57,43,0.1); }

.btn-row { display: flex; gap: 8px; }
.btn-row .btn { flex: 1; }
.mt8 { margin-top: 8px; }
.mt14 { margin-top: 14px; }
.mt18 { margin-top: 18px; }

/* ── PHASE HEADER ── */
.phase-hdr {
display: flex;
align-items: baseline;
justify-content: space-between;
margin-bottom: 18px;
padding-bottom: 12px;
border-bottom: 1px solid var(–border-dim);
}
.phase-title {
font-family: ‘Oswald’, sans-serif;
font-size: 1.25rem;
font-weight: 600;
letter-spacing: 0.15em;
color: var(–amber);
}
.phase-rd {
font-family: ‘Share Tech Mono’, monospace;
font-size: 0.68rem;
color: var(–cream-dim);
letter-spacing: 0.08em;
}

/* ── ROUND INFO ── */
.rinfo { margin-bottom: 14px; }
.rinfo-name {
font-family: ‘Oswald’, sans-serif;
font-size: 1.3rem;
font-weight: 600;
letter-spacing: 0.07em;
color: var(–cream);
}
.rinfo-desc { font-size: 0.7rem; color: var(–cream-dim); margin-top: 4px; letter-spacing: 0.04em; }

/* ── SPECIAL BADGE ── */
.sbadge {
display: inline-flex;
align-items: center;
gap: 6px;
background: rgba(74,124,63,0.12);
border: 1px solid var(–green);
padding: 5px 10px;
font-size: 0.67rem;
color: var(–green-bright);
letter-spacing: 0.08em;
margin-bottom: 13px;
font-family: ‘Oswald’, sans-serif;
}

/* ── BID BAR ── */
.bid-bar {
display: flex;
align-items: center;
justify-content: space-between;
padding: 9px 13px;
background: rgba(0,0,0,0.3);
border: 1px solid var(–border-dim);
margin-bottom: 13px;
font-size: 0.72rem;
color: var(–cream-dim);
letter-spacing: 0.07em;
transition: border-color 0.15s, background 0.15s;
}
.bid-bar.warn { border-color: rgba(192,57,43,0.45); background: rgba(192,57,43,0.07); }
.bid-bar-lhs { display: flex; align-items: baseline; gap: 6px; }
.bid-total {
font-family: ‘Oswald’, sans-serif;
font-size: 1rem;
font-weight: 600;
color: var(–amber);
transition: color 0.15s;
}
.bid-total.warn { color: #e74c3c; }
.bid-forbidden { font-family: ‘Oswald’, sans-serif; font-size: 0.7rem; }
.bid-forbidden span { color: #e74c3c; font-size: 1rem; font-weight: 700; }

/* ── STEPPER ROW ── */
.stepper-row {
background: rgba(0,0,0,0.18);
border: 1px solid var(–border-dim);
padding: 12px 14px;
margin-bottom: 9px;
display: flex;
align-items: center;
gap: 10px;
transition: border-color 0.15s;
}
.stepper-row.is-dealer { border-left: 2px solid var(–amber-dim); }
.stepper-row.is-eldest { border-left: 2px solid rgba(74,124,63,0.6); }

.sinfo { flex: 1; min-width: 0; }
.sname {
font-family: ‘Oswald’, sans-serif;
font-size: 0.95rem;
letter-spacing: 0.07em;
color: var(–cream);
white-space: nowrap;
overflow: hidden;
text-overflow: ellipsis;
}
.stag {
font-size: 0.55rem;
color: var(–amber-dim);
letter-spacing: 0.12em;
text-transform: uppercase;
margin-top: 2px;
}
.ssub {
font-size: 0.63rem;
color: var(–cream-dim);
margin-top: 3px;
letter-spacing: 0.04em;
min-height: 14px;
}
.ssub.hit { color: var(–green-bright); }
.ssub.miss { color: var(–cream-dim); }
.ssub.warn { color: #e06050; }

.scontrols { display: flex; align-items: center; flex-shrink: 0; }
.sbtn {
width: 50px;
height: 54px;
background: rgba(0,0,0,0.38);
border: 1px solid var(–border-dim);
color: var(–cream);
font-size: 1.35rem;
cursor: pointer;
display: flex;
align-items: center;
justify-content: center;
transition: background 0.1s;
-webkit-tap-highlight-color: transparent;
touch-action: manipulation;
user-select: none;
line-height: 1;
}
.sbtn.dec { border-right: none; }
.sbtn.inc { border-left: none; }
.sbtn:active { background: var(–amber-glow); }
.sbtn:disabled { opacity: 0.2; cursor: not-allowed; }
.sval {
min-width: 52px;
height: 54px;
display: flex;
align-items: center;
justify-content: center;
font-family: ‘Oswald’, sans-serif;
font-size: 1.9rem;
font-weight: 700;
color: var(–amber);
background: rgba(0,0,0,0.45);
border: 1px solid var(–border-dim);
}
.sval.green { color: var(–green-bright); }

.sind { font-size: 1rem; flex-shrink: 0; width: 18px; text-align: center; }

/* ── TRICK TOTAL BAR ── */
.tricks-bar {
display: flex;
align-items: center;
justify-content: space-between;
padding: 8px 13px;
background: rgba(0,0,0,0.25);
border: 1px solid var(–border-dim);
margin-bottom: 13px;
font-size: 0.7rem;
color: var(–cream-dim);
letter-spacing: 0.07em;
}
.tricks-bar.warn { border-color: rgba(192,57,43,0.35); }
.tricks-remaining {
font-family: ‘Oswald’, sans-serif;
font-size: 1rem;
font-weight: 600;
color: var(–green-bright);
}
.tricks-remaining.warn { color: #e74c3c; }

/* ── PROGRESS PIPS ── */
.progress-strip { display: flex; gap: 3px; flex-wrap: wrap; margin-bottom: 18px; }
.pip {
width: 8px; height: 8px;
border: 1px solid var(–border-dim);
cursor: pointer;
transition: all 0.15s;
flex-shrink: 0;
}
.pip.done { background: var(–amber-dim); border-color: var(–amber-dim); }
.pip.current { background: var(–amber); border-color: var(–amber); box-shadow: 0 0 6px rgba(232,168,32,0.65); }
.pip.special { border-radius: 50%; }
.pip.special.done { background: var(–green); border-color: var(–green); }
.pip.special.current { background: var(–green-bright); border-color: var(–green-bright); box-shadow: 0 0 6px rgba(107,181,96,0.65); }

/* ── SCORE TABLE ── */
.sc-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; }
.sc-table { width: 100%; border-collapse: collapse; font-size: 0.73rem; }
.sc-table th {
font-family: ‘Oswald’, sans-serif;
font-size: 0.58rem;
letter-spacing: 0.14em;
color: var(–amber-dim);
padding: 7px 9px;
border-bottom: 1px solid var(–border);
text-align: left;
background: rgba(0,0,0,0.2);
white-space: nowrap;
}
.sc-table th.pcol { text-align: center; min-width: 72px; }
.sc-table td { padding: 7px 9px; border-bottom: 1px solid var(–border-dim); vertical-align: middle; }
.sc-table td.rtd { white-space: nowrap; font-size: 0.66rem; }
.sc-table td.rtd .rn { font-family: ‘Special Elite’, cursive; color: var(–cream); }
.sc-table td.rtd .rc { color: var(–cream-dim); font-size: 0.6rem; }
.sc-table td.ptd { text-align: center; }
.spts { font-family: ‘Oswald’, sans-serif; font-size: 0.95rem; font-weight: 600; }
.spts.hit { color: var(–amber); }
.spts.miss { color: var(–cream-dim); }
.spts.neg { color: var(–red); }
.smeta { font-size: 0.58rem; color: var(–cream-dim); display: block; }
.smeta.hit { color: var(–green-bright); }
.srun { font-size: 0.62rem; color: var(–cream-dim); display: block; }
.sc-table tfoot td { padding: 11px 9px; border-top: 2px solid var(–amber); background: var(–panel); }
.ttl { font-family: ‘Oswald’, sans-serif; font-size: 1.25rem; font-weight: 700; color: var(–amber); display: block; text-align: center; }
.ttl-lbl { font-family: ‘Oswald’, sans-serif; font-size: 0.53rem; letter-spacing: 0.14em; color: var(–amber-dim); display: block; text-align: center; }
.rbadge { display: inline-block; font-family: ‘Oswald’, sans-serif; font-size: 0.53rem; padding: 1px 4px; margin-top: 2px; letter-spacing: 0.08em; }
.rbadge.r1 { background: var(–amber); color: var(–ink); }
.rbadge.r2 { background: rgba(232,168,32,0.18); color: var(–amber); }
.rbadge.r3 { background: transparent; color: var(–cream-dim); border: 1px solid var(–border-dim); }

/* ── GAME OVER ── */
.go-panel {
text-align: center;
padding: 36px 18px;
background: var(–panel);
border: 2px solid var(–amber);
position: relative;
margin-bottom: 18px;
}
.go-panel::before {
content: ‘’;
position: absolute;
top: 0; left: 0; right: 0;
height: 4px;
background: linear-gradient(90deg, transparent, var(–amber), transparent);
}
.go-title {
font-family: ‘Oswald’, sans-serif;
font-size: 2.4rem;
font-weight: 700;
color: var(–amber);
letter-spacing: 0.3em;
text-shadow: 0 0 36px rgba(232,168,32,0.45);
margin-bottom: 5px;
}
.go-sub {
font-family: ‘Special Elite’, cursive;
color: var(–cream-dim);
letter-spacing: 0.12em;
font-size: 0.72rem;
margin-bottom: 26px;
}
.stand-row {
display: flex;
align-items: center;
padding: 11px 0;
border-bottom: 1px solid var(–border-dim);
gap: 13px;
text-align: left;
}
.stand-rank { font-family: ‘Oswald’, sans-serif; font-size: 1.2rem; font-weight: 700; color: var(–amber-dim); min-width: 26px; }
.stand-row.p1 .stand-rank { color: var(–amber); }
.stand-name { font-family: ‘Special Elite’, cursive; font-size: 0.95rem; flex: 1; }
.stand-pts { font-family: ‘Oswald’, sans-serif; font-size: 1.15rem; font-weight: 600; color: var(–amber); }

/* ── RULES BUTTON ── */
.rules-btn {
background: transparent;
border: 1px solid var(–border-dim);
color: var(–cream-dim);
font-family: ‘Oswald’, sans-serif;
font-size: 0.65rem;
letter-spacing: 0.18em;
padding: 5px 10px;
cursor: pointer;
margin-left: auto;
flex-shrink: 0;
-webkit-tap-highlight-color: transparent;
touch-action: manipulation;
}
.rules-btn:active { border-color: var(–amber-dim); color: var(–cream); }

/* ── RULES SCREEN ── */
.rules-back {
display: flex;
align-items: center;
gap: 10px;
margin-bottom: 20px;
padding-bottom: 14px;
border-bottom: 1px solid var(–border-dim);
}
.rules-back-btn {
background: transparent;
border: 1px solid var(–border-dim);
color: var(–cream-dim);
font-family: ‘Oswald’, sans-serif;
font-size: 0.72rem;
letter-spacing: 0.15em;
padding: 8px 13px;
cursor: pointer;
-webkit-tap-highlight-color: transparent;
touch-action: manipulation;
}
.rules-back-btn:active { border-color: var(–amber); color: var(–cream); }
.rules-title {
font-family: ‘Oswald’, sans-serif;
font-size: 1.1rem;
font-weight: 600;
letter-spacing: 0.18em;
color: var(–amber);
}

/* Accordion */
.acc-item {
border: 1px solid var(–border-dim);
margin-bottom: 7px;
background: var(–panel);
}
.acc-trigger {
width: 100%;
background: transparent;
border: none;
color: var(–cream);
font-family: ‘Oswald’, sans-serif;
font-size: 0.85rem;
letter-spacing: 0.12em;
text-align: left;
padding: 13px 14px;
cursor: pointer;
display: flex;
align-items: center;
justify-content: space-between;
gap: 10px;
-webkit-tap-highlight-color: transparent;
touch-action: manipulation;
}
.acc-trigger:active { background: var(–amber-glow); }
.acc-trigger.open { color: var(–amber); border-bottom: 1px solid var(–border-dim); }
.acc-chevron {
font-size: 0.75rem;
color: var(–amber-dim);
transition: transform 0.2s;
flex-shrink: 0;
}
.acc-trigger.open .acc-chevron { transform: rotate(180deg); }
.acc-body {
display: none;
padding: 14px;
font-size: 0.78rem;
color: var(–cream-dim);
line-height: 1.7;
letter-spacing: 0.02em;
}
.acc-body.open { display: block; }

/* Rules typography */
.rules-h {
font-family: ‘Oswald’, sans-serif;
font-size: 0.65rem;
letter-spacing: 0.25em;
color: var(–amber-dim);
text-transform: uppercase;
margin-bottom: 6px;
margin-top: 14px;
}
.rules-h:first-child { margin-top: 0; }
.rules-p { margin-bottom: 9px; }
.rules-p:last-child { margin-bottom: 0; }
.rules-hl { color: var(–cream); }
.rules-amber { color: var(–amber); font-family: ‘Oswald’, sans-serif; letter-spacing: 0.05em; }
.rules-green { color: var(–green-bright); }
.rules-red { color: #e06050; }
.rules-dl { margin-top: 6px; }
.rules-dt {
font-family: ‘Oswald’, sans-serif;
color: var(–cream);
font-size: 0.78rem;
letter-spacing: 0.08em;
margin-top: 10px;
margin-bottom: 2px;
}
.rules-dd { padding-left: 0; margin-bottom: 4px; }
.rules-suit { font-size: 1rem; line-height: 1; }
.rules-table { width: 100%; border-collapse: collapse; margin: 8px 0; font-size: 0.74rem; }
.rules-table th { font-family: ‘Oswald’, sans-serif; font-size: 0.58rem; letter-spacing: 0.12em; color: var(–amber-dim); padding: 5px 8px; border-bottom: 1px solid var(–border-dim); text-align: left; }
.rules-table td { padding: 5px 8px; border-bottom: 1px solid rgba(212,200,154,0.07); color: var(–cream-dim); }
.rules-table td:first-child { color: var(–cream); font-family: ‘Oswald’, sans-serif; letter-spacing: 0.05em; font-size: 0.76rem; white-space: nowrap; }
.rules-divider { height: 1px; background: var(–border-dim); margin: 12px 0; }
</style>

</head>
<body>
<div class="container">

<header>
  <div class="header-inner">
    <svg class="roundel" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
      <circle cx="50" cy="50" r="48" fill="#003087"/>
      <circle cx="50" cy="50" r="34" fill="#fff"/>
      <circle cx="50" cy="50" r="20" fill="#cf111a"/>
    </svg>
    <div>
      <div class="clag-title">CLAG</div>
      <div class="clag-sub">CLOUDS LOW AIRCRAFT GROUNDED</div>
    </div>
    <button class="rules-btn" onclick="openRules()">? RULES</button>
  </div>
</header>

<!-- RESUME BANNER -->

<div id="resume-banner" style="display:none">
  <div class="resume-banner">
    <div class="resume-text"><strong id="resume-desc"></strong><br>Resume saved game?</div>
    <div class="resume-btns">
      <button class="btn btn-secondary" onclick="resumeGame()">RESUME</button>
      <button class="btn btn-danger" onclick="discardSave()">NEW</button>
    </div>
  </div>
</div>

<!-- SETUP -->

<div id="setup-screen" class="screen active">
  <div class="panel">
    <div class="slabel">Personnel — 3 to 7 players</div>
    <div id="player-inputs"></div>
  </div>
  <div class="panel">
    <div class="slabel">Game Type</div>
    <div class="radio-grid">
      <label class="rcard"><input type="radio" name="gametype" value="standard6" checked>
        <span class="rlabel"><span class="rlabel-title">STANDARD</span><span class="rlabel-sub">20 rounds (Foss)</span></span></label>
      <label class="rcard"><input type="radio" name="gametype" value="standard8">
        <span class="rlabel"><span class="rlabel-title">EXTENDED</span><span class="rlabel-sub">22 rounds (McLeod)</span></span></label>
      <label class="rcard"><input type="radio" name="gametype" value="scottish">
        <span class="rlabel"><span class="rlabel-title">SCOTTISH</span><span class="rlabel-sub">18 rounds</span></span></label>
      <label class="rcard"><input type="radio" name="gametype" value="quick">
        <span class="rlabel"><span class="rlabel-title">QUICK</span><span class="rlabel-sub">13 rounds</span></span></label>
    </div>
  </div>
  <div class="panel">
    <div class="slabel">Scoring</div>
    <div class="radio-grid">
      <label class="rcard"><input type="radio" name="scoring" value="2" checked>
        <span class="rlabel"><span class="rlabel-title">STANDARD</span><span class="rlabel-sub">+10 bid / +2 trick</span></span></label>
      <label class="rcard"><input type="radio" name="scoring" value="1">
        <span class="rlabel"><span class="rlabel-title">SCOTTISH</span><span class="rlabel-sub">+10 bid / +1 trick</span></span></label>
    </div>
  </div>
  <button class="btn btn-primary" onclick="startGame()">▶ BEGIN SORTIE</button>
</div>

<!-- BID SCREEN -->

<div id="bid-screen" class="screen">
  <div class="phase-hdr">
    <div class="phase-title">BIDDING</div>
    <div class="phase-rd" id="bid-rd"></div>
  </div>
  <div class="rinfo">
    <div class="rinfo-name" id="bid-rname"></div>
    <div class="rinfo-desc" id="bid-rdesc"></div>
  </div>
  <div id="bid-sbadge"></div>
  <div id="bid-bar"></div>
  <div id="bid-players"></div>
  <button class="btn btn-primary mt14" id="btn-confirm-bids" onclick="confirmBids()">CONFIRM BIDS →</button>
  <button class="btn btn-ghost mt8" onclick="openScorecard('bid')">VIEW SCORECARD</button>
</div>

<!-- TRICKS SCREEN -->

<div id="tricks-screen" class="screen">
  <div class="phase-hdr">
    <div class="phase-title">TRICK ENTRY</div>
    <div class="phase-rd" id="tricks-rd"></div>
  </div>
  <div class="rinfo">
    <div class="rinfo-name" id="tricks-rname"></div>
  </div>
  <div id="tricks-sbadge"></div>
  <div id="tricks-bar"></div>
  <div id="tricks-players"></div>
  <button class="btn btn-primary mt14" onclick="confirmTricks()">CONFIRM TRICKS →</button>
  <button class="btn btn-ghost mt8" onclick="openScorecard('tricks')">VIEW SCORECARD</button>
</div>

<!-- SCORECARD SCREEN -->

<div id="scorecard-screen" class="screen">
  <div class="phase-hdr">
    <div class="phase-title">SCORECARD</div>
    <div class="phase-rd" id="sc-rd"></div>
  </div>
  <div class="progress-strip" id="sc-pips"></div>
  <div class="sc-wrap">
    <table class="sc-table" id="sc-table"></table>
  </div>
  <div class="btn-row mt18">
    <button class="btn btn-secondary" id="btn-sc-back" onclick="scorecardBack()" style="display:none">◀ BACK</button>
    <button class="btn btn-primary" id="btn-sc-advance" onclick="scorecardAdvance()">NEXT ROUND ▶</button>
  </div>
  <button class="btn btn-ghost mt8" onclick="endGameEarly()">END GAME EARLY</button>
</div>

<!-- RULES -->

<div id="rules-screen" class="screen">
  <div class="rules-back">
    <button class="rules-back-btn" onclick="closeRules()">◀ BACK</button>
    <div class="rules-title">BRIEFING NOTES</div>
  </div>

  <!-- HOW TO PLAY -->

  <div class="acc-item">
    <button class="acc-trigger open" onclick="toggleAcc(this)">
      HOW TO PLAY <span class="acc-chevron">▼</span>
    </button>
    <div class="acc-body open">
      <div class="rules-h">The Basics</div>
      <p class="rules-p">Clag is a <span class="rules-hl">trick-taking</span> card game. Each round, every player is dealt a hand of cards, one suit is named <span class="rules-hl">trumps</span>, and players take turns playing one card to each <span class="rules-hl">trick</span>. The aim is to win exactly as many tricks as you predicted.</p>

```
  <div class="rules-h">Playing a Trick</div>
  <p class="rules-p"><span class="rules-hl">The leader</span> plays any card face-up. Going clockwise, every other player must <span class="rules-hl">follow suit</span> if they can — they must play a card of the same suit as the card led.</p>
  <p class="rules-p">If a player <span class="rules-hl">cannot follow suit</span>, they may play any card, including a trump.</p>
  <p class="rules-p">The trick is won by:<br>
    — the <span class="rules-amber">highest trump</span> played, if any trumps were played<br>
    — otherwise the <span class="rules-amber">highest card of the suit led</span>
  </p>
  <p class="rules-p">The winner of a trick <span class="rules-hl">leads the next one</span>.</p>

  <div class="rules-h">Card Ranking</div>
  <p class="rules-p">Standard ranking: <span class="rules-hl">2 (low) → Ace (high)</span>. Aces are always high unless playing Aces Low.</p>
</div>
```

  </div>

  <!-- WHO GOES FIRST -->

  <div class="acc-item">
    <button class="acc-trigger" onclick="toggleAcc(this)">
      WHO GOES FIRST <span class="acc-chevron">▼</span>
    </button>
    <div class="acc-body">
      <div class="rules-h">The Dealer</div>
      <p class="rules-p">One player deals the cards for each round. The dealer role rotates clockwise each round — this app tracks it automatically and shows who the dealer is during bidding.</p>
      <p class="rules-p">After dealing, the top card of the remaining stock is turned over to reveal <span class="rules-hl">trumps</span>.</p>

```
  <div class="rules-h">Eldest Hand</div>
  <p class="rules-p"><span class="rules-amber">Eldest hand</span> is the player immediately to the <span class="rules-hl">left of the dealer</span>. They have two privileges each round:</p>
  <p class="rules-p">① They <span class="rules-hl">bid first</span><br>② They <span class="rules-hl">lead the first trick</span></p>
  <p class="rules-p">Bidding continues clockwise from eldest hand. The <span class="rules-amber">dealer bids last</span> and faces the constraint: their bid cannot bring the total equal to the number of cards dealt — so someone is always guaranteed to fail their bid.</p>
</div>
```

  </div>

  <!-- BIDDING & SCORING -->

  <div class="acc-item">
    <button class="acc-trigger" onclick="toggleAcc(this)">
      BIDDING &amp; SCORING <span class="acc-chevron">▼</span>
    </button>
    <div class="acc-body">
      <div class="rules-h">Bidding</div>
      <p class="rules-p">Before play, each player declares how many tricks they expect to win. You can bid <span class="rules-hl">zero</span> — in fact, bidding zero and taking none scores exactly the same bonus as any other correct bid.</p>
      <p class="rules-p">The sum of all bids <span class="rules-red">must not equal</span> the number of cards dealt. The dealer bids last and is forbidden from making it balance — this ensures at least one player cannot succeed.</p>

```
  <div class="rules-h">Scoring</div>
  <table class="rules-table">
    <thead><tr><th>Outcome</th><th>Standard</th><th>Scottish</th></tr></thead>
    <tbody>
      <tr><td>Correct bid</td><td>+10 bonus</td><td>+10 bonus</td></tr>
      <tr><td>Each trick won</td><td>+2 per trick</td><td>+1 per trick</td></tr>
      <tr><td>Wrong bid</td><td>0 (nothing)</td><td>0 (nothing)</td></tr>
    </tbody>
  </table>
  <p class="rules-p" style="margin-top:9px">Example (standard): bid 3, take 3 → <span class="rules-green">10 + 6 = 16 pts</span>. Bid 3, take 4 → <span class="rules-red">0 pts</span>.</p>
  <p class="rules-p">Even if you fail your bid, any tricks you take still count toward the total — they just don't score you anything.</p>

  <div class="rules-h">Winning</div>
  <p class="rules-p">The player with the <span class="rules-hl">highest total score</span> after all rounds wins. Scores accumulate across the whole game — there's no reset between rounds.</p>
</div>
```

  </div>

  <!-- GAME FORMATS -->

  <div class="acc-item">
    <button class="acc-trigger" onclick="toggleAcc(this)">
      GAME FORMATS <span class="acc-chevron">▼</span>
    </button>
    <div class="acc-body">
      <p class="rules-p">All formats share the same structure: cards dealt go up, then a middle section of special rounds, then back down again. The dealer rotates each round throughout.</p>

```
  <div class="rules-h">Standard — 20 Rounds (Foss)</div>
  <p class="rules-p">Phase 1: 1→7 cards. Phase 2: 6 special rounds (all 7 cards). Phase 3: 7→1 cards.</p>

  <div class="rules-h">Extended — 22 Rounds (McLeod)</div>
  <p class="rules-p">Same as Standard but with 8 special rounds in Phase 2, including Twos Wild, Aces Low, and Dealer Calls Trumps.</p>

  <div class="rules-h">Scottish — 18 Rounds</div>
  <p class="rules-p">Starts with 7→1 cards (so luck dominates the middle of the game, not the end), then 4 special rounds, then 1→7 cards. Skill matters most in the final phase. Often played with the +1 per trick scoring.</p>

  <div class="rules-h">Quick — 13 Rounds</div>
  <p class="rules-p">A shortened game: 1→5 cards, 3 special rounds, then 5→1 cards. Good for 3–4 players or when time is short.</p>
</div>
```

  </div>

  <!-- SPECIAL ROUNDS -->

  <div class="acc-item">
    <button class="acc-trigger" onclick="toggleAcc(this)">
      SPECIAL ROUNDS <span class="acc-chevron">▼</span>
    </button>
    <div class="acc-body">
      <p class="rules-p" style="margin-bottom:12px">Special rounds appear in Phase 2 of every format. Each modifies the normal rules in some way. Normal scoring applies unless stated.</p>

```
  <div class="rules-dt">No Trumps</div>
  <div class="rules-dd">No suit is trump. The highest card of the <span class="rules-hl">suit led</span> always wins the trick — you cannot trump out even if you're void in the led suit.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Guess 'Em / Guess Trumps</div>
  <div class="rules-dd">All players make their bids <span class="rules-hl">before</span> the trump card is turned over. Once every bid is locked in, trumps are revealed and play begins as normal.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Misère</div>
  <div class="rules-dd">The objective is inverted — you want to take <span class="rules-hl">as few tricks as possible</span>. You still bid, but only zero is rewarded. Scoring: <span class="rules-green">+10 for taking zero tricks</span>. <span class="rules-red">−3 per trick</span> if you take any. Trumps apply.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Misère No Trumps</div>
  <div class="rules-dd">As Misère, but with no trump suit. Penalty is <span class="rules-red">−2 per trick</span> rather than −3.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Blind</div>
  <div class="rules-dd">Each player bids <span class="rules-hl">before receiving their cards</span> (and before trumps are revealed). Once all bids are in, cards are dealt and play proceeds normally. Pure instinct and probability.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Roll 'Em</div>
  <div class="rules-dd">Players do <span class="rules-hl">not look at their cards</span>. Stack them face-down and play from the top of the pile in order — no choice, no peeking. You bid before seeing anything.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Misère — Scottish variant</div>
  <div class="rules-dd">As Misère above but the penalty is <span class="rules-red">−2 per trick</span>. Used in the Scottish 18-round format.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Twos Wild <span style="font-size:0.62rem;color:var(--cream-dim)"> (Extended only)</span></div>
  <div class="rules-dd">When a player plays a Two, they name its rank and suit on the spot — it beats the natural card it claims to be. Constraint: if a player holds a card of the suit led, their Two must be given that suit (no reneging by proxy).</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Aces Low <span style="font-size:0.62rem;color:var(--cream-dim)"> (Extended only)</span></div>
  <div class="rules-dd">Card ranking is reversed for Aces only — they become the <span class="rules-hl">lowest</span> cards in the deck (below 2s). All other cards rank normally.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Dealer Calls Trumps <span style="font-size:0.62rem;color:var(--cream-dim)"> (Extended only)</span></div>
  <div class="rules-dd">Instead of turning the stock, the <span class="rules-hl">dealer names trumps</span> after looking at their own hand. Everyone else bids first; the dealer sees their hand, picks a trump suit to their advantage, then bids last as usual.</div>

  <div class="rules-divider"></div>

  <div class="rules-dt">Most Tricks <span style="font-size:0.62rem;color:var(--cream-dim)"> (Extended only)</span></div>
  <div class="rules-dd">No bidding. The player who takes the <span class="rules-hl">most tricks</span> scores 10 points. If two or more players tie for the most, <span class="rules-red">nobody scores</span>.</div>
</div>
```

  </div>

  <!-- ORIGINS -->

  <div class="acc-item">
    <button class="acc-trigger" onclick="toggleAcc(this)">
      ORIGINS <span class="acc-chevron">▼</span>
    </button>
    <div class="acc-body">
      <p class="rules-p"><span class="rules-amber">CLAG</span> is an RAF acronym: <span class="rules-hl">Clouds Low Aircraft Grounded</span> — the condition that kept aircrews on the ground with nothing to do but play cards.</p>
      <p class="rules-p">The game originated in the Royal Air Force, purportedly during the Second World War, and spread through postings and National Service. Rules varied from station to station and squadron to squadron across the globe; attempts to unify the rules were made in the early 1990s.</p>
      <p class="rules-p">It was brought back to Scotland by RAF servicemen in the late 1950s and has since spread to touring cyclists as evening entertainment. Regional variants continue to multiply.</p>
      <p class="rules-p">It is similar to <span class="rules-hl">Oh Hell</span> (also called Nomination Whist or Blackout), but with a richer Phase 2, a firmer identity, and a considerably better name.</p>
    </div>
  </div>

<button class="btn btn-ghost mt14" onclick="closeRules()">◀ BACK TO GAME</button>

</div>

<!-- GAME OVER -->

<div id="gameover-screen" class="screen">
  <div class="go-panel">
    <div class="go-title">DEBRIEF</div>
    <div class="go-sub">Mission complete — final standings</div>
    <div id="go-standings"></div>
  </div>
  <div class="sc-wrap mt14">
    <table class="sc-table" id="go-table"></table>
  </div>
  <button class="btn btn-primary mt18" onclick="resetGame()">▶ NEW SORTIE</button>
</div>

</div><!-- /container -->

<script>
// ─── ROUND DEFINITIONS ────────────────────────────────────────────────────────

const FOSS_SPECIALS = [
  { name:'NO TRUMPS',     cards:7, special:'notrumps',    desc:'No trump suit — highest of led suit wins' },
  { name:"GUESS 'EM",    cards:7, special:'guess',        desc:'Trumps revealed only after all bids are locked in' },
  { name:'MISÈRE NT',    cards:7, special:'misere_nt',    desc:'No trumps — −2 per trick. +10 for taking zero.' },
  { name:'MISÈRE',       cards:7, special:'misere',       desc:'Trumps apply — −3 per trick. +10 for taking zero.' },
  { name:'BLIND',        cards:7, special:'blind',        desc:'Bid before receiving your cards' },
  { name:"ROLL 'EM",     cards:7, special:'rollem',       desc:'Stack face-down — play from the top in order' },
];
const MCLEOD_SPECIALS = [
  { name:'NO TRUMPS',    cards:7, special:'notrumps',    desc:'No trump suit — highest of led suit wins' },
  { name:'MISÈRE',       cards:7, special:'misere',      desc:'Trumps apply — +10 for taking zero tricks' },
  { name:'GUESS TRUMPS', cards:7, special:'guess',       desc:'Trumps revealed only after all bids are locked in' },
  { name:'BLIND',        cards:7, special:'blind',       desc:'Bid before receiving your cards' },
  { name:'TWOS WILD',    cards:7, special:'twos',        desc:'Played Twos: name rank/suit — beats the natural card' },
  { name:'ACES LOW',     cards:7, special:'aceslow',     desc:'Aces rank as the lowest cards in the deck' },
  { name:'DEALER CALLS', cards:7, special:'dealercalls', desc:'Dealer names trumps after viewing their hand' },
  { name:'MOST TRICKS',  cards:7, special:'mosttricks',  desc:'No bidding — player taking the most tricks scores 10' },
];
const SCOTTISH_SPECIALS = [
  { name:'NO TRUMPS',    cards:7, special:'notrumps',  desc:'No trump suit — highest of led suit wins' },
  { name:'MISÈRE',       cards:7, special:'misere',    desc:'−2 per trick. +10 for taking zero tricks.' },
  { name:"GUESS 'EM",   cards:7, special:'guess',      desc:'Bid before trumps are revealed' },
  { name:'BLIND',        cards:7, special:'blind',     desc:'Bid without seeing cards or trumps' },
];

const mk = n => ({ name:`${n} CARD${n>1?'S':''}`, cards:n, special:null, desc:`Standard — ${n} card${n>1?'s':''} each` });

function buildRounds(type) {
  const up   = [1,2,3,4,5,6,7].map(mk);
  const down = [7,6,5,4,3,2,1].map(mk);
  if (type==='standard6') return [...up,   ...FOSS_SPECIALS,    ...down];
  if (type==='standard8') return [...up,   ...MCLEOD_SPECIALS,  ...down];
  if (type==='scottish')  return [...down, ...SCOTTISH_SPECIALS, ...up];
  if (type==='quick')     return [...up.slice(0,5), ...FOSS_SPECIALS.slice(0,3), ...down.slice(0,5)];
  return [...up, ...FOSS_SPECIALS, ...down];
}

// ─── STATE ────────────────────────────────────────────────────────────────────

let G = null;                   // game state
let scReturnPhase = null;       // which phase the scorecard "Back" returns to

const SAVE_KEY  = 'clag_v3';
const NAMES_KEY = 'clag_names';

const save      = () => { try { localStorage.setItem(SAVE_KEY, JSON.stringify(G)); } catch(e){} };
const loadSave  = () => { try { return JSON.parse(localStorage.getItem(SAVE_KEY)); } catch(e){ return null; } };
const clearSave = () => localStorage.removeItem(SAVE_KEY);
const saveNames = n  => { try { localStorage.setItem(NAMES_KEY, JSON.stringify(n)); } catch(e){} };
const loadNames = () => { try { return JSON.parse(localStorage.getItem(NAMES_KEY))||[]; } catch(e){ return []; } };

// ─── SCORING ──────────────────────────────────────────────────────────────────

const isMisere     = r => r.special==='misere' || r.special==='misere_nt';
const isMostTricks = r => r.special==='mosttricks';

function roundPts(round, entry, perTrick) {
  const t = parseInt(entry.tricks);
  if (isNaN(t)) return null;
  if (isMostTricks(round)) return 0; // handled at round level

  if (round.special === 'misere_nt') return t===0 ? 10 : t*-2;
  if (round.special === 'misere')    return t===0 ? 10 : t*-3;

  const b = parseInt(entry.bid);
  if (isNaN(b)) return null;
  return b===t ? 10 + t*perTrick : 0;
}

function mostTricksWinner(ri) {
  const counts = G.players.map((_,pi) => parseInt(G.scores[ri][pi].tricks)||0);
  const max = Math.max(...counts);
  const sole = counts.filter(c=>c===max).length === 1;
  return { counts, max, sole };
}

function playerTotal(pi, upTo) {
  let t = 0;
  for (let ri=0; ri<=upTo; ri++) {
    const r = G.rounds[ri], e = G.scores[ri][pi];
    if (isMostTricks(r)) {
      if (e.tricks===''||e.tricks===null||e.tricks===undefined) continue;
      const {counts,max,sole} = mostTricksWinner(ri);
      if (counts[pi]===max && sole) t+=10;
    } else {
      const p = roundPts(r, e, G.perTrick);
      if (p!==null) t+=p;
    }
  }
  return t;
}

// ─── BID ORDER / DEALER ───────────────────────────────────────────────────────

const dealerFor = ri => ri % G.players.length;

function bidOrder(ri) {
  const n = G.players.length, d = dealerFor(ri), order=[];
  for (let i=1; i<=n; i++) order.push((d+i)%n);
  return order; // last = dealer
}

// ─── SCREENS ─────────────────────────────────────────────────────────────────

function show(id) {
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
  window.scrollTo(0,0);
}

// ─── SETUP ───────────────────────────────────────────────────────────────────

function initSetup() {
  const saved = loadNames();
  const c = document.getElementById('player-inputs');
  c.innerHTML = '';
  for (let i=0; i<7; i++) {
    const d = document.createElement('div');
    d.className = 'pinput-row';
    d.innerHTML = `<span class="pnum">P${i+1}</span>
      <input type="text" id="pi${i}" value="${saved[i]||''}"
        placeholder="${i<3?'Required':'Optional'}"
        maxlength="14" autocomplete="off" autocorrect="off" spellcheck="false">`;
    c.appendChild(d);
  }

  const sv = loadSave();
  const banner = document.getElementById('resume-banner');
  if (sv && sv.players && sv.rounds) {
    document.getElementById('resume-desc').textContent =
      `${sv.players.join(', ')} — Rd ${sv.currentRound+1}/${sv.rounds.length}`;
    banner.style.display = 'block';
  } else {
    banner.style.display = 'none';
  }
}

function resumeGame() {
  const sv = loadSave();
  if (!sv) return;
  G = sv;
  document.getElementById('resume-banner').style.display = 'none';
  goPhase(G.phase||'bid');
}

function discardSave() {
  clearSave();
  document.getElementById('resume-banner').style.display = 'none';
}

function startGame() {
  const players = [];
  for (let i=0; i<7; i++) {
    const v = document.getElementById(`pi${i}`).value.trim();
    if (i<3 && !v) { alert(`Player ${i+1} name is required.`); return; }
    if (v) players.push(v);
  }
  const gameType = document.querySelector('input[name="gametype"]:checked').value;
  const perTrick = parseInt(document.querySelector('input[name="scoring"]:checked').value);
  const rounds = buildRounds(gameType);

  G = {
    players,
    rounds,
    currentRound: 0,
    phase: 'bid',
    perTrick,
    scores: rounds.map(()=>players.map(()=>({bid:0, tricks:0}))),
  };

  saveNames(players);
  save();
  goPhase('bid');
}

// ─── PHASE NAVIGATION ────────────────────────────────────────────────────────

function goPhase(phase) {
  G.phase = phase;
  save();
  if (phase==='bid')       { show('bid-screen');       renderBid(); }
  if (phase==='tricks')    { show('tricks-screen');    renderTricks(); }
  if (phase==='scorecard') { show('scorecard-screen'); renderScorecard(); }
}

function openScorecard(fromPhase) {
  scReturnPhase = fromPhase;
  goPhase('scorecard');
}

function scorecardBack() {
  if (scReturnPhase) { goPhase(scReturnPhase); scReturnPhase = null; }
}

function scorecardAdvance() {
  if (G.currentRound === G.rounds.length-1) { showGameOver(); return; }
  G.currentRound++;
  // fresh entries for new round (keep defaults at 0)
  G.players.forEach((_,pi)=>{ G.scores[G.currentRound][pi]={bid:0,tricks:0}; });
  scReturnPhase = null;
  save();
  goPhase('bid');
}

// ─── BID SCREEN ───────────────────────────────────────────────────────────────

function renderBid() {
  const ri = G.currentRound, round = G.rounds[ri];

  // MOST TRICKS has no bidding — skip straight to tricks
  if (isMostTricks(round)) { goPhase('tricks'); return; }

  document.getElementById('bid-rd').textContent = `ROUND ${ri+1} / ${G.rounds.length}`;
  document.getElementById('bid-rname').textContent = round.name;
  document.getElementById('bid-rdesc').textContent = round.desc;
  document.getElementById('bid-sbadge').innerHTML = round.special
    ? `<div class="sbadge">⚡ ${round.desc}</div>` : '';

  const order = bidOrder(ri);
  const dealer = dealerFor(ri);
  const mis = isMisere(round);

  const c = document.getElementById('bid-players');
  c.innerHTML = '';
  order.forEach((pi, oi) => {
    const isDealer  = pi === dealer;
    const isEldest  = oi === 0;
    const val = parseInt(G.scores[ri][pi].bid)||0;

    const row = document.createElement('div');
    row.className = 'stepper-row' + (isDealer?' is-dealer':(isEldest?' is-eldest':''));
    row.id = `br${pi}`;

    let tag = isDealer ? 'DEALER — BIDS LAST' : (isEldest ? 'ELDEST HAND — LEADS FIRST' : '');

    row.innerHTML = `
      <div class="sinfo">
        <div class="sname">${G.players[pi].toUpperCase()}</div>
        ${tag ? `<div class="stag">${tag}</div>` : ''}
        <div class="ssub" id="bsub${pi}"></div>
      </div>
      <div class="scontrols">
        <button class="sbtn dec" id="bdec${pi}" onclick="adjBid(${pi},-1)" ${mis?'disabled':''}>−</button>
        <div class="sval" id="bval${pi}">${mis?0:val}</div>
        <button class="sbtn inc" id="binc${pi}" onclick="adjBid(${pi},+1)" ${mis?'disabled':''}>+</button>
      </div>`;
    c.appendChild(row);
  });

  if (mis) G.players.forEach((_,pi)=>{ G.scores[ri][pi].bid=0; });

  updateBidBar();
  updateBidBtns();
}

function bidTotal() {
  const ri = G.currentRound;
  return G.players.reduce((s,_,pi)=>s+(parseInt(G.scores[ri][pi].bid)||0),0);
}

function updateBidBar() {
  const ri = G.currentRound, round = G.rounds[ri];
  const total = bidTotal(), forbidden = round.cards;
  const warn = total === forbidden;
  document.getElementById('bid-bar').innerHTML = `
    <div class="bid-bar${warn?' warn':''}">
      <div class="bid-bar-lhs">
        <span style="font-size:0.7rem">Total bids:</span>
        <span class="bid-total${warn?' warn':''}">${total}</span>
      </div>
      <span class="bid-forbidden">Forbidden: <span>${forbidden}</span></span>
    </div>`;
  const btn = document.getElementById('btn-confirm-bids');
  if (btn) btn.disabled = warn;
}

function adjBid(pi, delta) {
  const ri = G.currentRound, round = G.rounds[ri];
  const dealer = dealerFor(ri);
  let v = (parseInt(G.scores[ri][pi].bid)||0) + delta;
  if (v<0 || v>round.cards) return;

  if (pi === dealer) {
    const others = G.players.reduce((s,_,i)=>i===pi?s:s+(parseInt(G.scores[ri][i].bid)||0),0);
    const forb = round.cards - others;
    if (v === forb) { v += delta; if (v<0||v>round.cards) return; }
  }

  G.scores[ri][pi].bid = v;
  document.getElementById(`bval${pi}`).textContent = v;
  save();
  updateBidBar();
  updateBidBtns();
}

function updateBidBtns() {
  const ri = G.currentRound, round = G.rounds[ri];
  const dealer = dealerFor(ri);
  G.players.forEach((_,pi) => {
    const v = parseInt(G.scores[ri][pi].bid)||0;
    const dec = document.getElementById(`bdec${pi}`);
    const inc = document.getElementById(`binc${pi}`);
    const sub = document.getElementById(`bsub${pi}`);
    if (!dec||!inc) return;
    dec.disabled = v<=0;

    if (pi===dealer) {
      const others = G.players.reduce((s,_,i)=>i===pi?s:s+(parseInt(G.scores[ri][i].bid)||0),0);
      const forb = round.cards - others;
      const next = v+1===forb ? v+2 : v+1;
      inc.disabled = next>round.cards;
      if (sub && forb>=0 && forb<=round.cards) {
        sub.textContent = `Cannot bid ${forb}`;
        sub.className = 'ssub warn';
      }
    } else {
      inc.disabled = v>=round.cards;
    }
  });
}

function confirmBids() {
  const ri = G.currentRound, round = G.rounds[ri];
  if (bidTotal()===round.cards) { alert(`Total bids equal ${round.cards} — dealer must adjust.`); return; }
  goPhase('tricks');
}

// ─── TRICKS SCREEN ────────────────────────────────────────────────────────────

function renderTricks() {
  const ri = G.currentRound, round = G.rounds[ri];
  const mis = isMisere(round), hn = isMostTricks(round);

  document.getElementById('tricks-rd').textContent = `ROUND ${ri+1} / ${G.rounds.length}`;
  document.getElementById('tricks-rname').textContent = round.name;
  document.getElementById('tricks-sbadge').innerHTML = round.special
    ? `<div class="sbadge">⚡ ${round.desc}</div>` : '';

  const c = document.getElementById('tricks-players');
  c.innerHTML = '';

  G.players.forEach((name,pi) => {
    const bid = parseInt(G.scores[ri][pi].bid)||0;
    const val = parseInt(G.scores[ri][pi].tricks)||0;
    const row = document.createElement('div');
    row.className = 'stepper-row';
    row.id = `tr${pi}`;
    row.innerHTML = `
      <div class="sinfo">
        <div class="sname">${name.toUpperCase()}</div>
        <div class="ssub" id="tsub${pi}">${mis?'Must take 0': hn?'Most tricks wins':`Bid: ${bid}`}</div>
      </div>
      <div class="scontrols">
        <button class="sbtn dec" id="tdec${pi}" onclick="adjTricks(${pi},-1)">−</button>
        <div class="sval green" id="tval${pi}">${val}</div>
        <button class="sbtn inc" id="tinc${pi}" onclick="adjTricks(${pi},+1)">+</button>
      </div>
      <div class="sind" id="tind${pi}"></div>`;
    c.appendChild(row);
  });

  updateTricksBar();
  updateTrickIndicators();
}

function tricksTotal() {
  const ri = G.currentRound;
  return G.players.reduce((s,_,pi)=>s+(parseInt(G.scores[ri][pi].tricks)||0),0);
}

function updateTricksBar() {
  const ri = G.currentRound, round = G.rounds[ri];
  const total = tricksTotal(), remaining = round.cards - total;
  const warn = remaining < 0;
  document.getElementById('tricks-bar').innerHTML = `
    <div class="tricks-bar${warn?' warn':''}">
      <span>Tricks remaining:</span>
      <span class="tricks-remaining${warn?' warn':''}">${remaining}</span>
    </div>`;
}

function adjTricks(pi, delta) {
  const ri = G.currentRound, round = G.rounds[ri];
  const cur = parseInt(G.scores[ri][pi].tricks)||0;
  const newv = cur+delta;
  if (newv<0) return;
  const total = tricksTotal();
  if (delta>0 && (total-cur+newv)>round.cards) return;
  G.scores[ri][pi].tricks = newv;
  document.getElementById(`tval${pi}`).textContent = newv;
  save();
  updateTricksBar();
  updateTrickIndicators();
}

function updateTrickIndicators() {
  const ri = G.currentRound, round = G.rounds[ri];
  const mis = isMisere(round), hn = isMostTricks(round);
  const total = tricksTotal(), remaining = round.cards - total;

  G.players.forEach((_,pi) => {
    const tricks = parseInt(G.scores[ri][pi].tricks)||0;
    const bid    = parseInt(G.scores[ri][pi].bid)||0;
    const dec = document.getElementById(`tdec${pi}`);
    const inc = document.getElementById(`tinc${pi}`);
    const sub = document.getElementById(`tsub${pi}`);
    const ind = document.getElementById(`tind${pi}`);
    if (dec) dec.disabled = tricks<=0;
    if (inc) { const after=(total-tricks)+(tricks+1); inc.disabled=after>round.cards; }

    if (hn) {
      if (sub) sub.textContent = 'Most tricks wins';
      if (ind) { ind.textContent=''; }
      return;
    }
    if (mis) {
      const pts = round.special==='misere_nt' ? (tricks===0?10:tricks*-2) : (tricks===0?10:tricks*-3);
      if (sub) { sub.textContent=`${pts>=0?'+':''}${pts} pts`; sub.className=`ssub ${tricks===0?'hit':'miss'}`; }
      if (ind) { ind.textContent=tricks===0?'✓':'✗'; ind.style.color=tricks===0?'var(--green-bright)':'var(--red)'; }
      return;
    }
    const hit = tricks===bid;
    if (sub) {
      if (hit) { const p=10+tricks*G.perTrick; sub.textContent=`Bid ${bid} ✓ +${p} pts`; sub.className='ssub hit'; }
      else      { sub.textContent=`Bid ${bid} — 0 pts`; sub.className='ssub miss'; }
    }
    if (ind) { ind.textContent=hit?'✓':(tricks>bid?'↑':'↓'); ind.style.color=hit?'var(--green-bright)':'var(--cream-dim)'; }
  });
}

function confirmTricks() {
  const ri = G.currentRound, round = G.rounds[ri];
  const total = tricksTotal();
  if (total!==round.cards) {
    if (!confirm(`Total tricks (${total}) ≠ cards dealt (${round.cards}). Continue anyway?`)) return;
  }
  scReturnPhase = null;
  goPhase('scorecard');
}

// ─── SCORECARD ────────────────────────────────────────────────────────────────

function renderScorecard() {
  const ri = G.currentRound;
  document.getElementById('sc-rd').textContent = `ROUND ${ri+1} / ${G.rounds.length}`;

  const isLast = ri===G.rounds.length-1;
  document.getElementById('btn-sc-advance').textContent = isLast ? 'FINISH SORTIE ▶' : 'NEXT ROUND ▶';
  const backBtn = document.getElementById('btn-sc-back');
  backBtn.style.display = scReturnPhase ? 'inline-flex' : 'none';

  // Pips
  const strip = document.getElementById('sc-pips');
  strip.innerHTML = '';
  G.rounds.forEach((r,i) => {
    const p = document.createElement('div');
    p.className = 'pip' + (r.special?' special':'');
    if (i<ri) p.classList.add('done');
    if (i===ri) p.classList.add('current');
    strip.appendChild(p);
  });

  // Table
  buildScoreTable('sc-table', ri);
}

function buildScoreTable(tableId, upTo) {
  const { players, rounds, scores, perTrick } = G;
  const totals = players.map((_,pi)=>playerTotal(pi,upTo));
  const sorted = [...totals].sort((a,b)=>b-a);

  let h = `<thead><tr><th>Round</th>${players.map(p=>`<th class="pcol">${p.toUpperCase()}</th>`).join('')}</tr></thead><tbody>`;

  rounds.forEach((round, ri) => {
    if (ri>upTo) return;
    const cur = ri===upTo;
    h += `<tr${cur?' style="background:rgba(232,168,32,0.05)"':''}>
      <td class="rtd"><span class="rn">${ri+1}. ${round.name}</span><br><span class="rc">${round.cards}c</span></td>`;

    players.forEach((_,pi) => {
      const e = scores[ri][pi];
      let cell = '';

      if (isMostTricks(round)) {
        const t = parseInt(e.tricks);
        if (!isNaN(t)) {
          const {counts,max,sole} = mostTricksWinner(ri);
          const won = counts[pi]===max && sole;
          const run = playerTotal(pi,ri);
          cell = `<span class="spts ${won?'hit':'miss'}">${won?'+10':'0'}</span>
            <span class="smeta">${t}T</span>
            <span class="srun">${run}</span>`;
        } else { cell='—'; }
      } else {
        const pts = roundPts(round,e,perTrick);
        if (pts===null) { cell='—'; }
        else {
          const bid=parseInt(e.bid), tr2=parseInt(e.tricks);
          const hit = !isNaN(bid)&&!isNaN(tr2)&&bid===tr2&&!isMisere(round);
          const cls = pts>0?'hit':pts<0?'neg':'miss';
          const meta = isMisere(round)?`${tr2}T`:`${bid}→${tr2}`;
          const run = playerTotal(pi,ri);
          cell = `<span class="spts ${cls}">${pts>=0?'+'+pts:pts}</span>
            <span class="smeta ${hit?'hit':''}">${meta}</span>
            <span class="srun">${run}</span>`;
        }
      }
      h += `<td class="ptd">${cell}</td>`;
    });
    h += '</tr>';
  });

  h += `</tbody><tfoot><tr><td style="font-family:'Oswald',sans-serif;font-size:0.58rem;letter-spacing:0.14em;color:var(--amber-dim)">TOTAL</td>`;
  players.forEach((_,pi) => {
    const t=totals[pi], rank=sorted.indexOf(t)+1;
    const b = rank<=3?`<span class="rbadge r${rank}">${['1ST','2ND','3RD'][rank-1]}</span>`:'';
    h += `<td class="ptd"><span class="ttl">${t}</span><span class="ttl-lbl">pts</span><br>${b}</td>`;
  });
  h += '</tr></tfoot>';
  document.getElementById(tableId).innerHTML = h;
}

// ─── GAME OVER ────────────────────────────────────────────────────────────────

function endGameEarly() {
  if (!confirm('End the game early and see final standings?')) return;
  showGameOver();
}

function showGameOver() {
  clearSave();
  const ri = G.currentRound;
  const tots = G.players.map((p,pi)=>({name:p,pts:playerTotal(pi,ri)}));
  tots.sort((a,b)=>b.pts-a.pts);

  document.getElementById('go-standings').innerHTML = tots.map((p,i)=>`
    <div class="stand-row${i===0?' p1':''}">
      <div class="stand-rank">${i+1}</div>
      <div class="stand-name">${p.name}</div>
      <div class="stand-pts">${p.pts} pts</div>
    </div>`).join('');

  buildScoreTable('go-table', ri);
  show('gameover-screen');
}

function resetGame() {
  G = null; clearSave();
  show('setup-screen');
  initSetup();
}

// ─── RULES ───────────────────────────────────────────────────────────────────

let rulesReturnScreen = null;

function openRules() {
  // figure out where we came from
  const active = document.querySelector('.screen.active');
  rulesReturnScreen = active ? active.id : 'setup-screen';
  show('rules-screen');
}

function closeRules() {
  if (rulesReturnScreen) { show(rulesReturnScreen); }
  else { show('setup-screen'); }
  rulesReturnScreen = null;
}

function toggleAcc(trigger) {
  const body = trigger.nextElementSibling;
  const isOpen = trigger.classList.contains('open');
  trigger.classList.toggle('open', !isOpen);
  body.classList.toggle('open', !isOpen);
}

// ─── INIT ─────────────────────────────────────────────────────────────────────
initSetup();
</script>

</body>
</html>